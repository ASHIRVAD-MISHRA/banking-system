{% extends 'accounts/base.html' %}

{% block title %}Transaction History - SecureBank{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <a href="{% url 'account_detail' account.account_number %}" class="btn btn-outline-light mb-3">
            <i class="fas fa-arrow-left me-2"></i>Back to Account
        </a>
        <h1 class="text-white fw-bold mb-2">
            <i class="fas fa-history"></i> Transaction History
        </h1>
    </div>
</div>

<!-- Account Summary Card -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card bg-gradient" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <div class="card-body text-white">
                <div class="row align-items-center">
                    <div class="col-md-3 text-center border-end">
                        <h6 class="mb-2 opacity-75">Account Number</h6>
                        <h4 class="fw-bold mb-0">{{ account.account_number }}</h4>
                    </div>
                    <div class="col-md-3 text-center border-end">
                        <h6 class="mb-2 opacity-75">Account Type</h6>
                        <h4 class="fw-bold mb-0">{{ account.get_account_type_display }}</h4>
                    </div>
                    <div class="col-md-3 text-center border-end">
                        <h6 class="mb-2 opacity-75">Current Balance</h6>
                        <h4 class="fw-bold mb-0">₹{{ account.balance|floatformat:2 }}</h4>
                    </div>
                    <div class="col-md-3 text-center">
                        <h6 class="mb-2 opacity-75">Total Transactions</h6>
                        <h4 class="fw-bold mb-0">{{ transactions.count }}</h4>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Filters and Export -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-filter me-2"></i>Filter Transactions
                </h6>
                <div class="row g-2">
                    <div class="col-md-6">
                        <select class="form-select" id="filter-type">
                            <option value="">All Types</option>
                            <option value="DEPOSIT">Deposits</option>
                            <option value="WITHDRAWAL">Withdrawals</option>
                            <option value="TRANSFER_IN">Transfers In</option>
                            <option value="TRANSFER_OUT">Transfers Out</option>
                            <option value="FEE">Fees</option>
                        </select>
                    </div>
                    <div class="col-md-6">
                        <select class="form-select" id="filter-period">
                            <option value="">All Time</option>
                            <option value="7">Last 7 Days</option>
                            <option value="30">Last 30 Days</option>
                            <option value="90">Last 3 Months</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card">
            <div class="card-body">
                <h6 class="fw-bold mb-3">
                    <i class="fas fa-download me-2"></i>Export Transactions
                </h6>
                <div class="d-grid gap-2 d-md-flex">
                    <button class="btn btn-outline-primary" onclick="window.print()">
                        <i class="fas fa-print me-2"></i>Print
                    </button>
                    <button class="btn btn-outline-success" onclick="exportToCSV()">
                        <i class="fas fa-file-csv me-2"></i>Export CSV
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Transaction Table -->
<div class="row">
    <div class="col-12">
        <div class="card shadow-lg">
            <div class="card-header">
                <i class="fas fa-list me-2"></i>All Transactions
            </div>
            <div class="card-body">
                {% if transactions %}
                <div class="table-responsive">
                    <table class="table table-hover" id="transactions-table">
                        <thead>
                            <tr>
                                <th>Transaction ID</th>
                                <th>Date & Time</th>
                                <th>Type</th>
                                <th>Description</th>
                                <th>Amount</th>
                                <th>Balance After</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for transaction in transactions %}
                            <tr data-type="{{ transaction.transaction_type }}" data-date="{{ transaction.timestamp|date:'Y-m-d' }}">
                                <td>
                                    <code class="small">{{ transaction.transaction_id }}</code>
                                </td>
                                <td>
                                    <div>{{ transaction.timestamp|date:"M d, Y" }}</div>
                                    <small class="text-muted">{{ transaction.timestamp|time:"H:i:s" }}</small>
                                </td>
                                <td>
                                    {% if transaction.transaction_type == 'DEPOSIT' %}
                                        <span class="badge bg-success">
                                            <i class="fas fa-arrow-down"></i> Deposit
                                        </span>
                                    {% elif transaction.transaction_type == 'WITHDRAWAL' %}
                                        <span class="badge bg-warning">
                                            <i class="fas fa-arrow-up"></i> Withdrawal
                                        </span>
                                    {% elif transaction.transaction_type == 'TRANSFER_IN' %}
                                        <span class="badge bg-info">
                                            <i class="fas fa-arrow-right"></i> Transfer In
                                        </span>
                                    {% elif transaction.transaction_type == 'TRANSFER_OUT' %}
                                        <span class="badge bg-primary">
                                            <i class="fas fa-arrow-left"></i> Transfer Out
                                        </span>
                                    {% elif transaction.transaction_type == 'FEE' %}
                                        <span class="badge bg-secondary">
                                            <i class="fas fa-receipt"></i> Fee
                                        </span>
                                    {% else %}
                                        <span class="badge bg-secondary">{{ transaction.get_transaction_type_display }}</span>
                                    {% endif %}
                                </td>
                                <td>
                                    <small>{{ transaction.description }}</small>
                                </td>
                                <td>
                                    <span class="fw-bold {% if transaction.transaction_type == 'DEPOSIT' or transaction.transaction_type == 'TRANSFER_IN' %}text-success{% else %}text-danger{% endif %}">
                                        {% if transaction.transaction_type == 'DEPOSIT' or transaction.transaction_type == 'TRANSFER_IN' %}
                                            <i class="fas fa-plus"></i>
                                        {% else %}
                                            <i class="fas fa-minus"></i>
                                        {% endif %}
                                        ₹{{ transaction.amount|floatformat:2 }}
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-bold">₹{{ transaction.balance_after|floatformat:2 }}</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <!-- Summary Statistics -->
                <div class="row mt-4">
                    <div class="col-md-12">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="fw-bold mb-3">Summary Statistics</h6>
                                <div class="row text-center">
                                    <div class="col-md-3">
                                        <div class="icon-box success mx-auto mb-2" style="width: 50px; height: 50px;">
                                            <i class="fas fa-arrow-down"></i>
                                        </div>
                                        <h6 class="text-muted small">Total Deposits</h6>
                                        <h5 class="fw-bold text-success" id="total-deposits">₹0.00</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="icon-box warning mx-auto mb-2" style="width: 50px; height: 50px;">
                                            <i class="fas fa-arrow-up"></i>
                                        </div>
                                        <h6 class="text-muted small">Total Withdrawals</h6>
                                        <h5 class="fw-bold text-warning" id="total-withdrawals">₹0.00</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="icon-box info mx-auto mb-2" style="width: 50px; height: 50px;">
                                            <i class="fas fa-exchange-alt"></i>
                                        </div>
                                        <h6 class="text-muted small">Total Transfers</h6>
                                        <h5 class="fw-bold text-info" id="total-transfers">₹0.00</h5>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="icon-box secondary mx-auto mb-2" style="width: 50px; height: 50px;">
                                            <i class="fas fa-receipt"></i>
                                        </div>
                                        <h6 class="text-muted small">Total Fees</h6>
                                        <h5 class="fw-bold text-secondary" id="total-fees">₹0.00</h5>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                {% else %}
                <div class="text-center py-5">
                    <div class="icon-box warning mx-auto mb-3" style="width: 80px; height: 80px; font-size: 2rem;">
                        <i class="fas fa-receipt"></i>
                    </div>
                    <h4 class="text-muted mb-3">No Transactions Found</h4>
                    <p class="text-muted mb-4">This account doesn't have any transactions yet.</p>
                    <a href="{% url 'account_detail' account.account_number %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Account
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Calculate summary statistics
    const transactions = {{ transactions|safe|default:"[]" }};
    
    let totalDeposits = 0;
    let totalWithdrawals = 0;
    let totalTransfers = 0;
    let totalFees = 0;
    
    {% for transaction in transactions %}
    {% if transaction.transaction_type == 'DEPOSIT' %}
        totalDeposits += {{ transaction.amount }};
    {% elif transaction.transaction_type == 'WITHDRAWAL' %}
        totalWithdrawals += {{ transaction.amount }};
    {% elif transaction.transaction_type == 'TRANSFER_IN' or transaction.transaction_type == 'TRANSFER_OUT' %}
        totalTransfers += {{ transaction.amount }};
    {% elif transaction.transaction_type == 'FEE' %}
        totalFees += {{ transaction.amount }};
    {% endif %}
    {% endfor %}
    
    document.getElementById('total-deposits').textContent = '₹' + totalDeposits.toFixed(2);
    document.getElementById('total-withdrawals').textContent = '₹' + totalWithdrawals.toFixed(2);
    document.getElementById('total-transfers').textContent = '₹' + totalTransfers.toFixed(2);
    document.getElementById('total-fees').textContent = '₹' + totalFees.toFixed(2);
    
    // Filter functionality
    const filterType = document.getElementById('filter-type');
    const filterPeriod = document.getElementById('filter-period');
    const tableRows = document.querySelectorAll('#transactions-table tbody tr');
    
    function filterTransactions() {
        const selectedType = filterType.value;
        const selectedPeriod = filterPeriod.value;
        const now = new Date();
        
        tableRows.forEach(row => {
            let showRow = true;
            
            // Filter by type
            if (selectedType && row.dataset.type !== selectedType) {
                showRow = false;
            }
            
            // Filter by period
            if (selectedPeriod) {
                const rowDate = new Date(row.dataset.date);
                const daysDiff = Math.floor((now - rowDate) / (1000 * 60 * 60 * 24));
                if (daysDiff > parseInt(selectedPeriod)) {
                    showRow = false;
                }
            }
            
            row.style.display = showRow ? '' : 'none';
        });
    }
    
    filterType.addEventListener('change', filterTransactions);
    filterPeriod.addEventListener('change', filterTransactions);
});

// Export to CSV
function exportToCSV() {
    const table = document.getElementById('transactions-table');
    let csv = [];
    
    // Headers
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.textContent);
    });
    csv.push(headers.join(','));
    
    // Rows
    table.querySelectorAll('tbody tr').forEach(row => {
        if (row.style.display !== 'none') {
            const cols = [];
            row.querySelectorAll('td').forEach(td => {
                cols.push('"' + td.textContent.trim().replace(/"/g, '""') + '"');
            });
            csv.push(cols.join(','));
        }
    });
    
    // Download
    const csvContent = csv.join('\n');
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'transactions_{{ account.account_number }}.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}
</script>

<style>
@media print {
    .btn, .card-header, nav, footer {
        display: none !important;
    }
    
    .card {
        border: 1px solid #000 !important;
        box-shadow: none !important;
    }
}
</style>
{% endblock %}